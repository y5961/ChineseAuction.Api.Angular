<div class="cart-container" dir="rtl">

  <div class="cart-header">
    <h2>住 拽转 砖</h2>
    <div class="ticket-badge">
      <div class="ticket-label">专住 砖砖</div>
      <div class="badge">
        <span>{{ cartService.totalGiftCount() }}</span>
        <span class="slash">/</span>
        <span>{{ cartService.totalTickets() }}</span>
      </div>
    </div>
  </div>

  @if (cartPackages().length > 0 || cartGifts().length > 0) {
    
    @if (cartPackages().length > 0) {
      <h3 style="color: #442604; font-size: 1.1em; margin-bottom: 12px; font-weight: 700;">转</h3>
      <div class="cart-items" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px;">
        @for (pkg of cartPackages(); track pkg.idPackage) {
          @if ((packageQuantities()[pkg.idPackage] || 0) > 0) {
            
            <div class="cart-item design-v2">
              <div class="trash-col">
                <button class="trash-btn" title="住专" (click)="decrement(pkg.idPackage)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 6h18" stroke="#7b5238" stroke-width="1.4" stroke-linecap="round"/>
                    <path d="M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="#7b5238" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10 11v4" stroke="#7b5238" stroke-width="1.4" stroke-linecap="round"/>
                    <path d="M14 11v4" stroke="#7b5238" stroke-width="1.4" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>

              <div class="price-col">
                <div class="price">{{ (pkg.price || 0) * (packageQuantities()[pkg.idPackage] || 0) }}</div>
                <div class="price-label">{{ pkg.price }} </div>
              </div>

              <div class="center-col">
                <div class="qty-box small">
                  <button (click)="increment(pkg.idPackage)" class="control-btn">+</button>
                  <span class="qty-display">{{ packageQuantities()[pkg.idPackage] }}</span>
                  <button (click)="decrement(pkg.idPackage)" class="control-btn">-</button>
                </div>
                <div class="pkg-name">{{ pkg.name }}</div>
              </div>

              <div class="badge-col">
                <div class="big-badge" [class.badge-orange]="(packageQuantities()[pkg.idPackage] || 0) <= 1" [class.badge-green]="(packageQuantities()[pkg.idPackage] || 0) > 1">
                  <div class="big-num">{{ packageQuantities()[pkg.idPackage] }}</div>
                  <div class="small-label">专住</div>
                </div>
              </div>
            </div>
          }
        }
      </div>
    }

    <!-- Gifts Section -->
    @if (cartGifts().length > 0) {
      <h3 style="color: #442604; font-size: 1.1em; margin-bottom: 12px; font-weight: 700;">驻专 专转</h3>
      <div class="cart-gifts" style="display: flex; flex-direction: column; gap: 12px;">
        @for (gift of cartGifts(); track gift.idGift) {
          @if ((giftQuantities()[gift.idGift] || gift.amount || 0) > 0) {
            
            <div class="cart-item design-v2 gift-row">
              <div class="trash-col">
                <button class="trash-btn" title="住专" (click)="decrementGift(gift.idGift)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 6h18" stroke="#7b5238" stroke-width="1.4" stroke-linecap="round"/>
                    <path d="M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="#7b5238" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10 11v4" stroke="#7b5238" stroke-width="1.4" stroke-linecap="round"/>
                    <path d="M14 11v4" stroke="#7b5238" stroke-width="1.4" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>

              <div class="center-col">
                <div class="qty-box small">
                  <button (click)="incrementGift(gift.idGift)" class="control-btn">+</button>
                  <span class="qty-display">{{ giftQuantities()[gift.idGift] || gift.amount || 0 }}</span>
                  <button (click)="decrementGift(gift.idGift)" class="control-btn">-</button>
                </div>
                <div class="pkg-name">{{ gift.name }}</div>
              </div>

              <div class="item-thumb">
                @if (gift.image && gift.image.trim() && gift.image !== 'string') {
                  <img [src]="giftImageUrl + gift.image">
                } @else {
                  <div class="placeholder-gift"></div>
                }
              </div>
            </div>
          }
        }
      </div>
    }

    <div class="ticket-progress">
      <div class="tp-row">
        <div class="tp-counter">{{ cartService.totalGiftCount() }} / {{ cartService.totalTickets() }}</div>
        <div class="tp-label">转专  砖</div>
        <div class="tp-icons">
          <div class="gift-icon">
            <img src="/assets/icons/gift-small.png" alt="gift">
            <span class="gift-badge">{{ cartService.totalGiftCount() }}</span>
          </div>
        </div>
      </div>

      <div class="progress-track">
        <div class="progress-fill" [style.width.%]="cartService.totalTickets() ? (cartService.totalGiftCount() / cartService.totalTickets()) * 100 : 0"></div>
      </div>

      <div class="tp-actions">
        <button class="big-next" (click)="goToPackages()">砖 </button>
      </div>
    </div>

  } @else {
    <div class="empty-state">
      <div class="empty-emoji"></div>
      <p>住 砖 注 专拽</p>
    </div>
  }
  
</div>

  @if (cartService.ticketModal()) {
    <div class="ticket-modal">
      <div class="ticket-backdrop" (click)="cartService.closeTicketLimitModal()"></div>
      <div class="ticket-dialog">
        <div class="ticket-title"> 住驻拽 专住 注</div>
        <div class="ticket-body">{{ cartService.ticketMessage() }}</div>
        <div class="ticket-actions">
          <button (click)="cartService.closeTicketLimitModal()" class="btn-alt">砖</button>
          <button (click)="goToPackages()" class="btn-primary">专砖 注 专住</button>
        </div>
      </div>
    </div>
  }
    @if (cartService.ticketModal()) {
      <app-ticket-limit-modal></app-ticket-limit-modal>
    }





