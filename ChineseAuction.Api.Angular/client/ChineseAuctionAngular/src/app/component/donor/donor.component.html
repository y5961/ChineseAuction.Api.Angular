<div class="table-container">
  <div class="header-actions">
    <div class="title-section">
      <h2 class="main-title">ניהול תורמים - מתנת חיים</h2>
      
      <div class="filter-wrapper">
        <div class="search-input-group">
          <span class="search-icon">🔍</span>
          <input type="text" 
                 [ngModel]="searchQuery()" 
                 (ngModelChange)="searchQuery.set($event); onSearchInput()"
                 [placeholder]="'חיפוש לפי ' + activeFilterName() + '...'">
          
          <div class="spinner-inline" *ngIf="isLoading()"></div>
          <span class="clear-icon" *ngIf="searchQuery() && !isLoading()" (click)="clearSearch()">✖️</span>
        </div>
        
        <div class="filter-buttons">
          <button [class.active]="currentFilter() === 'name'" (click)="setFilter('name', 'שם')">לפי שם</button>
          <button [class.active]="currentFilter() === 'email'" (click)="setFilter('email', 'אימייל')">לפי אימייל</button>
          <button [class.active]="currentFilter() === 'gift'" (click)="setFilter('gift', 'מתנה')">לפי מתנה</button>
        </div>
      </div>
    </div>
    
    <button class="btn-add-donor" (click)="showAddModal = true">
      <span class="plus-icon">+</span> הוספת תורם חדש
    </button>
  </div>
  
  <table class="donor-table">
    <thead>
      <tr>
        <th>שם פרטי</th>
        <th>שם משפחה</th>
        <th>אימייל</th>
        <th>טלפון</th>
        <th>מתנות</th>
        <th>ניהול</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let donor of donors()">
        <tr [class.expanded-row]="expandedDonorId() === donor.idDonor || addingGiftToDonorId() === donor.idDonor">
          <td>{{ donor.firstName }}</td>
          <td>{{ donor.lastName }}</td>
          <td>{{ donor.email }}</td>
          <td>{{ donor.phoneNumber }}</td>
          <td>
            <button class="btn-toggle" (click)="toggleGifts(donor)">
              {{ expandedDonorId() === donor.idDonor ? 'סגור' : 'הצג מתנות' }}
            </button>              
          </td>
          <td class="actions-cell">
            <button class="btn-icon edit" (click)="openEditModal(donor)" title="ערוך">✏️</button>
            <button class="btn-icon delete" (click)="confirmDelete(donor)" title="מחק">❌</button>
            
            <button class="btn-gift-action" 
                    [class.active]="addingGiftToDonorId() === donor.idDonor"
                    (click)="confirmAddGift(donor)">
              <span class="icon">🎁</span>
              <span class="text">הוסף מתנה</span>
            </button>
          </td>
        </tr>

        <tr *ngIf="addingGiftToDonorId() === donor.idDonor" class="inline-expand-row">
          <td colspan="6">
            <div class="inner-expand-card add-gift-card">
              <div class="card-header">
                <h3>הוספת מתנה חדשה עבור {{ donor.firstName }} {{ donor.lastName }}</h3>
                <button class="close-inline" (click)="addingGiftToDonorId.set(null)">✖</button>
              </div>
              <app-add-gift 
                [donorId]="donor.idDonor" 
                (giftAdded)="onGiftAddedSuccessfully(donor.idDonor)">
              </app-add-gift>
            </div>
          </td>
        </tr>

        <tr *ngIf="expandedDonorId() === donor.idDonor" class="inline-expand-row">
          <td colspan="6">
            <div class="inner-expand-card">
              <div class="card-header">
                <h3>מתנות שנתרמו ע"י {{ donor.firstName }}</h3>
                <button class="close-inline" (click)="expandedDonorId.set(null)">✖</button>
              </div>
              <app-donor-gifts 
                [gifts]="donorGifts()[donor.idDonor] || []" 
                [donorName]="donor.firstName"
                [imageBaseUrl]="imageBaseUrl"
                (deleteGift)="deleteGiftFromDonor($event, donor.idDonor)">
              </app-donor-gifts>
            </div>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div class="modal-overlay" *ngIf="showAddModal">
    <div class="modal-card">
      <h3 class="modal-title">הוספת תורם חדש</h3>
      <div class="modal-form">
        <input type="text" [(ngModel)]="newDonor.firstName" placeholder="שם פרטי">
        <input type="text" [(ngModel)]="newDonor.lastName" placeholder="שם משפחה">
        <input type="email" [(ngModel)]="newDonor.email" placeholder="אימייל">
        <input type="text" [(ngModel)]="newDonor.phoneNumber" placeholder="טלפון">
      </div>
      <div class="modal-actions">
        <button class="btn-confirm" (click)="submitAddDonor()">הוסף תורם</button>
        <button class="btn-cancel" (click)="showAddModal = false">ביטול</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showEditModal">
    <div class="modal-card">
      <h3 class="modal-title">עריכת פרטי תורם</h3>
      <div class="modal-form" *ngIf="editingDonor">
        <input type="text" [(ngModel)]="editingDonor.firstName" placeholder="שם פרטי">
        <input type="text" [(ngModel)]="editingDonor.lastName" placeholder="שם משפחה">
        <input type="email" [(ngModel)]="editingDonor.email" placeholder="אימייל">
        <input type="text" [(ngModel)]="editingDonor.phoneNumber" placeholder="טלפון">
      </div>
      <div class="modal-actions">
        <button class="btn-confirm" (click)="submitEditDonor()">שמור שינויים</button>
        <button class="btn-cancel" (click)="showEditModal = false">ביטול</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="donorToDelete">
    <div class="modal-card">
      <h3 class="modal-title">אישור מחיקה</h3>
      <p style="text-align: center;">האם את בטוחה שברצונך למחוק את התורם <strong>{{ donorToDelete.firstName }} {{ donorToDelete.lastName }}</strong>?</p>
      <div class="modal-actions">
        <button class="btn-confirm" style="background-color: #ff4d4d;" (click)="executeDelete()">כן, מחק</button>
        <button class="btn-cancel" (click)="donorToDelete = null">ביטול</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="deleteError">
    <div class="modal-card">
      <h3 class="modal-title" style="color: #d32f2f;">⚠️ לא ניתן למחוק</h3>
      <p style="text-align: center; color: #d32f2f; font-size: 16px; line-height: 1.5;">{{ deleteError }}</p>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="deleteError = null" style="width: 100%;">סגור</button>
      </div>
    </div>
  </div>
</div>